<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>L7 Live Traffic — Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; }
    .bg-grid { background-image: radial-gradient(rgba(255,255,255,0.05) 1px, transparent 1px); background-size: 16px 16px; }
  </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen bg-grid">
  <div class="max-w-5xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl md:text-3xl font-bold tracking-tight">L7 Live Traffic</h1>
      <span id="statusDot" class="inline-flex items-center gap-2 text-sm text-slate-400">
        <span class="w-2.5 h-2.5 rounded-full bg-rose-400 animate-pulse"></span>
        <span>connecting…</span>
      </span>
    </header>

    <div class="grid gap-4 grid-cols-2 md:grid-cols-3 mb-6">
      <div class="rounded-2xl p-4 ring-1 ring-white/10 bg-slate-900/70 shadow-xl">
        <div class="text-xs uppercase text-slate-400">Total Requests</div>
        <div id="total" class="text-2xl font-bold mt-1">—</div>
      </div>
      <div class="rounded-2xl p-4 ring-1 ring-white/10 bg-slate-900/70 shadow-xl">
        <div class="text-xs uppercase text-slate-400">Current RPS</div>
        <div id="rps" class="text-2xl font-bold mt-1">—</div>
      </div>
      <div class="rounded-2xl p-4 ring-1 ring-white/10 bg-slate-900/70 shadow-xl">
        <div class="text-xs uppercase text-slate-400">1‑Minute Avg</div>
        <div id="avg" class="text-2xl font-bold mt-1">—</div>
      </div>
    </div>

    <div class="rounded-3xl ring-1 ring-white/10 bg-slate-900/60 p-4 md:p-6 shadow-2xl relative overflow-hidden">
      <canvas id="chart" height="150"></canvas>
      <div class="pointer-events-none absolute inset-0 bg-gradient-to-t from-slate-950/40 to-transparent"></div>
    </div>

    <footer class="mt-6 text-xs text-slate-400">
      Counts all incoming requests to this service (excluding the live stream). Keep this page open to watch traffic spikes in real time.
    </footer>
  </div>

  <script>
    const totalEl = document.getElementById('total');
    const rpsEl = document.getElementById('rps');
    const avgEl = document.getElementById('avg');
    const statusDot = document.getElementById('statusDot');

    const ctx = document.getElementById('chart').getContext('2d');
    const gradient = ctx.createLinearGradient(0, 0, 0, 300);
    gradient.addColorStop(0, 'rgba(99, 102, 241, 0.35)');
    gradient.addColorStop(1, 'rgba(99, 102, 241, 0.00)');
    const lineColor = '#818cf8';

    const chart = new Chart(ctx, {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'Requests / sec', data: [], borderWidth: 2, tension: 0.25, pointRadius: 0, borderColor: lineColor, fill: true, backgroundColor: gradient }] },
      options: {
        animation: { duration: 0 },
        responsive: true, maintainAspectRatio: false,
        scales: { x: { ticks: { color: '#94a3b8' }, grid: { display: false } }, y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.06)' } } },
        plugins: { legend: { labels: { color: '#e2e8f0' } }, tooltip: { mode: 'index', intersect: false } },
        elements: { line: { capBezierPoints: true } }
      }
    });

    const MAX_POINTS = 180;
    function addPoint(msTs, rps) {
      const time = new Date(msTs).toLocaleTimeString([], { hour12: false });
      chart.data.labels.push(time);
      chart.data.datasets[0].data.push(rps);
      if (chart.data.labels.length > MAX_POINTS) { chart.data.labels.shift(); chart.data.datasets[0].data.shift(); }
      chart.update();
    }

    let es;
    function connect() {
      try {
        es = new EventSource('/live');
        statusDot.children[0].className = "w-2.5 h-2.5 rounded-full bg-yellow-400 animate-pulse";
        statusDot.children[1].textContent = "connecting…";
        es.addEventListener('open', () => {
          statusDot.children[0].className = "w-2.5 h-2.5 rounded-full bg-emerald-400 animate-pulse";
          statusDot.children[1].textContent = "live";
        });
        es.addEventListener('metrics', (e) => {
          const d = JSON.parse(e.data);
          totalEl.textContent = d.total.toLocaleString();
          rpsEl.textContent = d.rps.toString();
          avgEl.textContent = d.avg1m.toString();
          addPoint(d.t, d.rps);
        });
        es.onerror = () => {
          statusDot.children[0].className = "w-2.5 h-2.5 rounded-full bg-rose-400 animate-pulse";
          statusDot.children[1].textContent = "reconnecting…";
          es.close();
          setTimeout(connect, 1500);
        };
      } catch (e) {
        setTimeout(connect, 2000);
      }
    }
    connect();
  </script>
</body>
</html>
